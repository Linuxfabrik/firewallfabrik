Integration with OS Running on the Firewall Machine
====================================================

.. sectnum::
   :start: 12

.. contents::
   :local:
   :depth: 2


FirewallFabrik generates firewall scripts for iptables and nftables tailored for integration with modern Linux systems running systemd. The generated script supports command-line arguments ``start``, ``stop``, ``status``, ``reload``, ``interfaces``, and ``test_interfaces``. The script can be integrated with systemd using a custom service unit.

The generated script is assembled from parts defined in configlets located in the FirewallFabrik package (``firewallfabrik/configlets/linux24/script_skeleton``). You can modify it following instructions in :doc:`13 - Configlets`.


Activating the Firewall Policy at Boot
---------------------------------------

The recommended way to activate the FirewallFabrik-generated policy at boot is to create a systemd service unit. This applies to both iptables and nftables firewalls.


Creating a systemd Service Unit
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Create a service unit file that runs the generated firewall script at boot. The script name matches the name of the firewall object in FirewallFabrik, with the extension ``.fw``.

.. code-block:: bash

   sudo $EDITOR /etc/systemd/system/firewallfabrik.service

Add the following content (adjust the script path to match your setup):

.. code-block:: ini

   [Unit]
   Description=FirewallFabrik firewall policy
   DefaultDependencies=no
   Before=network-pre.target
   Wants=network-pre.target
   After=local-fs.target

   [Service]
   Type=oneshot
   RemainAfterExit=yes
   ExecStart=/etc/firewall/guardian.fw start
   ExecStop=/etc/firewall/guardian.fw stop
   ExecReload=/etc/firewall/guardian.fw reload

   [Install]
   WantedBy=multi-user.target

Replace ``guardian.fw`` with the actual name of your firewall object.

Enable and start the service:

.. code-block:: bash

   sudo systemctl daemon-reload
   sudo systemctl enable firewallfabrik.service
   sudo systemctl start firewallfabrik.service


Disabling Conflicting Services
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When using FirewallFabrik to manage the firewall, disable any distribution-provided firewall services to avoid conflicts:

.. code-block:: bash

   # RHEL / Fedora / CentOS -- disable firewalld
   sudo systemctl disable --now firewalld

   # Debian / Ubuntu -- disable ufw
   sudo systemctl disable --now ufw

   # If nftables.service is active and you use FirewallFabrik for nftables
   sudo systemctl disable --now nftables

.. note::

   The script generated by FirewallFabrik does more than just set iptables or nftables rules. It also adds virtual IP addresses to the interfaces of the firewall, configures kernel parameters, and can check whether interfaces are present and up. Distribution-provided ``iptables-save``/``iptables-restore`` services only manage rules; other tasks performed by the FirewallFabrik-generated script will not be done upon reboot if you rely on those services.


Restarting the Policy when an Interface Address Changes
-------------------------------------------------------

The firewall policy script generated by FirewallFabrik determines the IP addresses of all dynamic interfaces and assigns them to variables, which it then uses in the policy rules. If an interface's address changes after the policy has been loaded, the firewall script needs to be restarted.

On modern systems using NetworkManager, you can use a dispatcher script:

.. code-block:: bash

   sudo $EDITOR /etc/NetworkManager/dispatcher.d/99-firewallfabrik

Add the following content:

.. code-block:: bash

   #!/bin/bash
   # Restart FirewallFabrik policy when an interface gets a new address
   if [ "$2" = "up" ] || [ "$2" = "dhcp4-change" ] || [ "$2" = "dhcp6-change" ]; then
       systemctl reload firewallfabrik.service 2>/dev/null || true
   fi

Make the script executable:

.. code-block:: bash

   sudo chmod +x /etc/NetworkManager/dispatcher.d/99-firewallfabrik

For systems using systemd-networkd instead of NetworkManager, create a networkd-dispatcher script in ``/etc/networkd-dispatcher/routable.d/`` with similar content.

For PPP connections (e.g. PPPoE), the ``/etc/ppp/ip-up`` script can be used to restart the firewall:

.. code-block:: bash

   #!/bin/bash
   systemctl reload firewallfabrik.service

.. note::

   Replace ``firewallfabrik.service`` with the actual service name if you chose a different name for the unit file.


Deploying with Configuration Management
----------------------------------------

In modern infrastructure, firewall policies are often deployed as part of an automated workflow rather than manually. The generated ``.fw`` script fits naturally into configuration management tools.


Ansible
~~~~~~~

An Ansible playbook to deploy a FirewallFabrik-generated policy might look like this:

.. code-block:: yaml

   ---
   - name: Deploy firewall policy
     hosts: firewalls
     become: true
     tasks:
       - name: Copy firewall script
         ansible.builtin.copy:
           src: "output/{{ inventory_hostname }}.fw"
           dest: /etc/firewall/{{ inventory_hostname }}.fw
           owner: root
           group: root
           mode: '0700'
         notify: Activate firewall

       - name: Ensure systemd service exists
         ansible.builtin.copy:
           src: firewallfabrik.service
           dest: /etc/systemd/system/firewallfabrik.service
           owner: root
           group: root
           mode: '0644'
         notify:
           - Reload systemd
           - Activate firewall

       - name: Enable firewall service
         ansible.builtin.systemd:
           name: firewallfabrik
           enabled: true
           daemon_reload: true

     handlers:
       - name: Reload systemd
         ansible.builtin.systemd:
           daemon_reload: true

       - name: Activate firewall
         ansible.builtin.systemd:
           name: firewallfabrik
           state: reloaded

This approach ensures that the firewall script is deployed consistently across all machines and activated in a controlled manner.


CI/CD Integration
~~~~~~~~~~~~~~~~~

For teams using a CI/CD pipeline, the typical workflow is:

1. Edit the firewall policy in the FirewallFabrik GUI.
2. Save and compile the policy (``Rules > Compile``).
3. Commit the ``.fwf`` source file and the generated ``.fw`` script(s) to Git.
4. A CI/CD pipeline (GitLab CI, GitHub Actions, Jenkins, etc.) picks up the change and runs the deployment playbook or script.

Example GitLab CI stage:

.. code-block:: yaml

   deploy-firewall:
     stage: deploy
     script:
       - ansible-playbook -i inventory deploy-firewall.yml
     only:
       changes:
         - output/*.fw
     when: manual

The ``when: manual`` gate ensures that firewall deployments are always explicitly triggered by an operator.

See :doc:`10 - Compiling and Installing a Policy` for details on compiling policies.
